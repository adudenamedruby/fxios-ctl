format_version: "8"
default_step_lib_source: "https://github.com/bitrise-io/bitrise-steplib.git"
project_type: ios
pipelines:
  pipeline_build_and_test:
    workflows:
      determine_apps_affected: {}
      firefox_configure_build:
        run_if:
          expression: '{{ enveq "BUILD_FIREFOX_IOS" "true" }}'
        depends_on:
          - determine_apps_affected
      focus_configure_build:
        run_if:
          expression: '{{ enveq "BUILD_FOCUS_IOS" "true" }}'
        depends_on:
          - determine_apps_affected
        # We don't build klar for new PR now, bu we can still
        # start klar_configure_build manually.
      klar_configure_build:
        run_if:
          expression: false
        depends_on:
          - determine_apps_affected
      run_firefox_ui_tests:
        run_if:
          expression: '{{ enveq "RUN_UI_TESTS" "Run_UI_Tests" }}'
        depends_on:
          - firefox_configure_build
        parallel: 5
      focus_ui_test:
        run_if:
          expression: '{{ enveq "RUN_UI_TESTS" "Run_UI_Tests" }}'
        depends_on:
          - focus_configure_build
        parallel: 1
  pipeline_build_and_test_focus:
    workflows:
      focus_configure_build: {}
      focus_ui_test:
        depends_on:
          - focus_configure_build
        parallel: 1

workflows:
  firefox_accessibility_test:
    before_run:
      - 1_git_clone_and_post_clone
      - 2_certificate_and_profile
      - 3_provisioning_and_npm_installation
    steps:
      - activate-ssh-key@4:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - restore-spm-cache@1:
          is_always_run: true
      - script@1.1:
          title: Build for Testing
          inputs:
            - content: |
                set -euxo pipefail
                echo "-- build-for-testing --"
                mkdir DerivedData

                xcodebuild -resolvePackageDependencies -onlyUsePackageVersionsFromResolvedFile
                xcodebuild "-project" "/Users/vagrant/git/firefox-ios/Client.xcodeproj" "-scheme" "Fennec" -configuration "Fennec_Testing" "CODE_SIGNING_ALLOWED=NO" -sdk "iphonesimulator" "-destination" "platform=iOS Simulator,name=iPhone 17,OS=26.1" "COMPILER_INDEX_STORE_ENABLE=NO" "build-for-testing" "CODE_SIGN_IDENTITY=" "CODE_SIGNING_REQUIRED=NO" "CODE_SIGNING_ALLOWED=NO" -derivedDataPath "/Users/vagrant/git/DerivedData" | xcpretty | tee xcodebuild_fennec.log

                ls /Users/vagrant/git/DerivedData/Build/Products
                ls /Users/vagrant/git/DerivedData

      - xcode-test-without-building@0.5.1:
          continue_on_fail: true
          timeout: 1200
          inputs:
            - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
            - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO" "CODE_SIGN_IDENTITY=" "CODE_SIGNING_REQUIRED=NO" "CODE_SIGNING_ALLOWED=NO"'
            - xctestrun: "/Users/vagrant/git/DerivedData/Build/Products/Fennec_AccessibilityTestPlan_iphonesimulator26.1-arm64.xctestrun"
            - maximum_test_repetitions: 2

      - script@1.2.1:
          title: Count failed tests
          is_always_run: true
          inputs:
            - content: |
                echo "Analyzing test results from: $BITRISE_XCRESULT_PATH"
                xcrun xcresulttool get --path "$BITRISE_XCRESULT_PATH" --format json > result.json --legacy

                echo "Search for failed tests..."
                FAILED_COUNT=$(jq -r '.metrics.testsFailedCount._value' result.json)

                echo "Total number of failures: $FAILED_COUNT"

                envman add --key ACCESSIBILITY_FAILED_TEST_COUNT --value "$FAILED_COUNT"

      - script@1.2.1:
          title: Collect All Accessibility Report Files
          is_always_run: true
          inputs:
            - content: |
                echo "ðŸ” Search reports inside the device sandbox..."

                mkdir -p "$BITRISE_DEPLOY_DIR"

                find ~/Library/Developer/CoreSimulator/Devices -type f -name "AccessibilityReport*.txt" -exec cp {} "$BITRISE_DEPLOY_DIR" \;
                find ~/Library/Developer/CoreSimulator/Devices -type f -name "AccessibilityReport*.csv" -exec cp {} "$BITRISE_DEPLOY_DIR" \;

                echo "Files copied to $BITRISE_DEPLOY_DIR:"
                ls -lh "$BITRISE_DEPLOY_DIR"

      - deploy-to-bitrise-io@2.9.2:
          is_always_run: true

      - slack@4.2.1:
          is_always_run: true
          inputs:
            - title: ""
            - author_name: ""
            - webhook_url: "$WEBHOOK_SLACK_TOKEN"
            - footer_icon: https://emoji.slack-edge.com/T027LFU12/testops-notify/d350cecb43e9e630.png
            - footer: Created by Mobile Test Engineering
            - pretext_on_error: "*Firefox-iOS* :firefox: *Accessibility Tests* :x:"
            - pretext: "*Firefox-iOS* :firefox: *Accessibility Tests* :white_check_mark:"
            - timestamp: "no"
            - fields: |
                Task | ${BITRISE_BUILD_URL}
                Number of A11y Failures | ${ACCESSIBILITY_FAILED_TEST_COUNT}
                Failures Report | ${BITRISE_BUILD_URL}
                Accessibility Reports | ${BITRISE_BUILD_URL}?tab=artifacts
            - buttons: |
                App|${BITRISE_APP_URL}
                #mobile-testeng|https://mozilla.slack.com/archives/C02KDDS9QM9
                Mana|https://mana.mozilla.org/wiki/display/MTE/Mobile+Test+Engineering

  firefox_configure_build:
    before_run:
      - 0_detect_standalone_build
      - 1_git_clone_and_post_clone
      - 2_certificate_and_profile
      - 3_provisioning_and_npm_installation
      - decision_to_run_UI_Tests
    steps:
      - activate-ssh-key@4.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - restore-spm-cache@2.1.1:
          is_always_run: true
      - activate-build-cache-for-xcode@0: {}
      - xcode-build-for-test@3:
          inputs:
            - scheme: Fennec
            - configuration: Fennec_Testing
            - project_path: /Users/vagrant/git/firefox-ios/Client.xcodeproj
            - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO" -allowProvisioningUpdates DEVELOPMENT_TEAM=$APPLE_TEAM_ID'
            - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
      - script@1.2.1:
          title: Detect number of warnings
          is_always_run: true
          inputs:
            - content: |
                set -e
                set -x

                echo "bitrise_xcode"
                COUNT_XCUI=$(./test-fixtures/generate-metrics.sh $BITRISE_XCODE_RAW_RESULT_TEXT_PATH all)

                envman add --key SHOW_WARNING_IN_SLACK --value Show_Warnings
                envman add --key SHOW_WARNING_COUNT_XCUI --value "$COUNT_XCUI"

                STR=$COUNT_XCUI
                SUB='greater'
                if [[ "$STR" == *"$SUB"* ]]; then
                    echo "Failure, the number of warnings increased"
                    exit 1
                fi
      - script@1.2.1:
          title: Remove cache
          is_always_run: true
          inputs:
            - content: |
                export PATH="${PATH#"$HOME/.bitrise-xcelerate/bin:"}"
                envman add --key PATH --value "$PATH"
      - script@1.2.1:
          title: Override xctestrun file to UnitTests
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -euxo pipefail

                # Point to the Unit tests plan instead of Accessibility
                UNIT_TESTS_XCTESTRUN="$BITRISE_TEST_BUNDLE_PATH/Fennec_UnitTest_iphonesimulator26.1-arm64.xctestrun"
                SMOKE_UI_XCTESTRUN="$BITRISE_TEST_BUNDLE_PATH/Fennec_Smoketest_iphonesimulator26.1-arm64.xctestrun"

                if [ ! -f "$UNIT_TESTS_XCTESTRUN" ]; then
                  echo "ERROR: .xctestrun file not found: $UNIT_TESTS_XCTESTRUN"
                  exit 1
                fi

                echo "Found UnitTest .xctestrun: $UNIT_TESTS_XCTESTRUN"
                envman add --key BITRISE_XCTESTRUN_UNIT_TEST_FILE_PATH --value "$UNIT_TESTS_XCTESTRUN"
                envman add --key BITRISE_XCTESTRUN_SMOKE_TEST_FILE_PATH --value "$SMOKE_UI_XCTESTRUN"

      - xcode-test-without-building@0.5.1:
          timeout: 1200
          inputs:
            - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
            - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO" "CODE_SIGN_IDENTITY=" "CODE_SIGNING_REQUIRED=NO" "CODE_SIGNING_ALLOWED=NO"'
            - xctestrun: $BITRISE_TEST_BUNDLE_PATH/Fennec_UnitTest_iphonesimulator26.1-arm64.xctestrun
            - maximum_test_repetitions: 2
      - xcode-test-shard-calculation@0:
          run_if: '{{enveq "BITRISE_TEST_BUNDLE_PATH" "" | not}}'
          inputs:
            - product_path: $BITRISE_XCTESTRUN_SMOKE_TEST_FILE_PATH
            - shard_count: 5
            - destination: $BITRISE_DESTINATION
          outputs:
            - BITRISE_TEST_SHARDS_PATH: BITRISE_TEST_SHARDS_PATH_FIREFOX
          is_always_run: true
      - save-spm-cache@1.3.1:
          is_always_run: true
      - script@1.1.1:
          title: Clean before deploying
          timeout: 360
          inputs:
            - content: |
                #!/usr/bin/env bash
                set -euo pipefail

                echo "Removing raw-xcodebuild-output.log to reduce artifact size"
                rm -f "$BITRISE_DEPLOY_DIR/raw-xcodebuild-output.log"

                echo "Keeping only one swiftlint report file"
                # Remove one format or duplicate copies
                rm -f "$BITRISE_DEPLOY_DIR/swiftlint_report.txt" || true

                echo "Removing unit test xcresult"
                rm -f "$BITRISE_DEPLOY_DIR/Test-Fennec_UnitTest_iphonesimulator18.6-arm64.xcresult.zip"
      - deploy-to-bitrise-io@2.10.0:
          run_if: '{{enveq "BITRISE_TEST_BUNDLE_PATH" "" | not}}'
          inputs:
            - pipeline_intermediate_files: |-
                BITRISE_TEST_SHARDS_PATH_FIREFOX
                BITRISE_TEST_BUNDLE_PATH
                BITRISE_XCTESTRUN_SMOKE_TEST_FILE_PATH
          is_always_run: true
      - script@1.1.1:
          title: Run Danger 2
          timeout: 360
          inputs:
            - content: |
                #!/usr/bin/env bash
                # Fail if any command fails
                set -e
                # Extract .xcresult using xcrun xccov
                echo "Generating coverage.json from xcresult..."
                xcrun xccov view --report --json "$BITRISE_XCRESULT_PATH" > coverage.json
                echo "coverage.json created successfully"

                # Define a cleanup function to remove the file
                function cleanup_coverage {
                  if [ -f coverage.json ]; then
                    echo "Removing coverage.json"
                    rm coverage.json
                  fi
                }
                # Register it to run on script exit
                trap cleanup_coverage EXIT

                echo "Running Danger"
                swift run danger-swift ci
      - slack@4.2.1:
          is_always_run: true
          inputs:
            - title: ""
            - author_name: ""
            - webhook_url: "$WEBHOOK_SLACK_TOKEN"
            - footer_icon: https://emoji.slack-edge.com/T027LFU12/testops-notify/d350cecb43e9e630.png
            - footer: Created by Mobile Test Engineering
            - pretext_on_error: "*Firefox-iOS* :firefox: *Build/XCUITests* :x:"
            - pretext: "*Firefox-iOS* :firefox: *Build/XCUITests* :white_check_mark:"
            - timestamp: "no"
            - fields: |
                Task | ${BITRISE_BUILD_URL}
                Owner | ${GIT_CLONE_COMMIT_AUTHOR_NAME}
                Commit | ${GIT_CLONE_COMMIT_MESSAGE_SUBJECT}
                Source-Workflow | ${BITRISE_TRIGGERED_WORKFLOW_TITLE}
                Branch | ${BITRISE_GIT_BRANCH}
                Warnings-in-code-test | ${SHOW_WARNING_COUNT_XCUI}
            - buttons: |
                App|${BITRISE_APP_URL}
                #mobile-testeng|https://mozilla.slack.com/archives/C02KDDS9QM9
                Mana|https://mana.mozilla.org/wiki/display/MTE/Mobile+Test+Engineering
      - slack@4.2.1:
          is_always_run: true
          run_if: '{{getenv "NEW_RC_VERSION" | eq "New_RC_Version" | and .IsBuildFailed}}'
          inputs:
            - channel: "#firefox-ios"
            - text: Build status using latest Rust-Component
            - webhook_url: $WEBHOOK_SLACK_TOKEN_2

  run_firefox_ui_tests:
    before_run:
      - 1_git_clone_and_post_clone
      - 2_certificate_and_profile
    steps:
      - pull-intermediate-files@1: {}
      - xcode-test-without-building@0.5.1:
          timeout: 1200
          inputs:
            - only_testing: $BITRISE_TEST_SHARDS_PATH_FIREFOX/$BITRISE_IO_PARALLEL_INDEX
            - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
            - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO"'
            - xctestrun: $BITRISE_TEST_BUNDLE_PATH/Fennec_Smoketest_iphonesimulator26.1-arm64.xctestrun
      - deploy-to-bitrise-io@2.10.0: {}
  determine_apps_affected:
    steps:
      - git-clone@6.2: {}
      - script@1.2.1:
          title: Determine which application to base configuration
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e

                # Determine which application to base configuration while comparing against branch destination:
                # Bitrise: https://devcenter.bitrise.io/en/references/available-environment-variables.html
                #
                # BITRISEIO_GIT_BRANCH_DEST is used only on pull requests and is set to destination/branch (i.e, release/v123 )
                # BITRISE_GIT_BRANCH is the git branch that is built by Bitrise (i.e, release/v123 )
                # BITRISE_GIT_COMMIT is the git commit hash that is built by Bitrise
                #
                # If the destination branch is a release or epic branch, we need to compare changes against that destination branch
                # If the branch built by Bitrise is a release or epic branch, we need to compare changes against that branch
                # Otherwise, we need to compare changes against origin/main

                if [[ $BITRISEIO_GIT_BRANCH_DEST = release* ]] || [[ $BITRISEIO_GIT_BRANCH_DEST = epic* ]]; then
                    BASE_BRANCH="$BITRISEIO_GIT_BRANCH_DEST"
                    echo $BASE_BRANCH
                elif [[ $BITRISE_GIT_BRANCH = release* ]] || [[ $BITRISE_GIT_BRANCH = epic* ]]; then
                    BASE_BRANCH="$BITRISE_GIT_BRANCH"
                    echo $BASE_BRANCH
                else
                    BASE_BRANCH="origin/main"
                    echo $BASE_BRANCH
                fi

                # Determine apps affected by the changes introduced in the commit/PR
                APPS_AFFECTED=$(git diff --name-only $BASE_BRANCH..."$BITRISE_GIT_COMMIT" | xargs -n1 dirname | sort | uniq)

                echo "These are the files changed:"
                echo $APPS_AFFECTED

                # Initialize all application flags as "false" by default
                BUILD_FIREFOX_IOS="false"
                BUILD_FOCUS_IOS="false"
                BUILD_SAMPLE_BROWSER_IOS="false"

                # Manual triggers leave empty commits.
                # Check for empty commit/PR and exit blacklist check if found to avoid erroring out.
                echo "Files changed in commit/PR: $APPS_AFFECTED"
                if [[ -z "$APPS_AFFECTED" ]]; then
                    echo "No files changed in commit/PR. Skipping Blacklist check..."
                    # Set environment variables
                    envman add --key BUILD_FIREFOX_IOS --value "true"
                    envman add --key BUILD_FOCUS_IOS --value "true"
                    exit 0
                fi

                # Skip building on only markdown, LICENSE, and PR template changes
                TOTAL_CHANGED_FILES_COUNT=$(git diff --name-only $BASE_BRANCH..."$BITRISE_GIT_COMMIT" | wc -l | xargs)
                DOCS_ONLY_FILE_COUNT=$(git diff --name-only $BASE_BRANCH..."$BITRISE_GIT_COMMIT" \
                    | grep -Eci '(\.md$|^LICENSE$|^PULL_REQUEST_TEMPLATE$)' | xargs)

                if [ "$TOTAL_CHANGED_FILES_COUNT" -eq "$DOCS_ONLY_FILE_COUNT" ] && [ "$DOCS_ONLY_FILE_COUNT" -ne 0 ]; then
                    echo "Only Markdown, LICENSE or template files have been changed. No build will be triggered."
                    exit 0
                fi

                # Check for specific applications and set flags accordingly
                # Add more specific conditions for directories as needed; otherwise see default case
                # Pattern matches (*) on directory names and reacts to subdirectory changes as well
                for app in $APPS_AFFECTED; do
                    # Check for root directory changes
                    if [[ "$app" == "." ]]; then
                        CHANGED_FILES=$(git diff --name-only $BASE_BRANCH..."$BITRISE_GIT_COMMIT")
                        echo "Project root changes detected: $CHANGED_FILES"
                        ROOT_SPECIFIC_FILES=$(echo "$CHANGED_FILES" | grep -E '^(bootstrap\.sh|content_blocker_update\.sh|Dangerfile\.swift|Info\.plist|iOSNimbusFeatureUtility\.sh|package\.lock|Package\.json|Package\.resolved|Package\.swift|rust_components_local\.sh|setup_build_tools\.sh|update_version\.sh|\.swiftlint\.yml)$' || true)
                        echo "Root specific files: $ROOT_SPECIFIC_FILES"
                        if [ ! -z "$ROOT_SPECIFIC_FILES" ]; then
                            BUILD_FIREFOX_IOS="true"
                        fi
                    fi

                    case "$app" in
                        firefox-ios*)
                            BUILD_FIREFOX_IOS="true"
                            ;;
                        focus-ios*)
                            BUILD_FOCUS_IOS="true"
                            ;;
                        SampleBrowser*)
                            BUILD_SAMPLE_BROWSER_IOS="true"
                            ;;
                        BrowserKit*|taskcluster*|test-fixtures*)
                            # Explicitly directory changes - build all applications
                            BUILD_FIREFOX_IOS="true"
                            BUILD_FOCUS_IOS="true"
                            ;;
                        ".")
                            # Root directory changes - build all applications
                            BUILD_FIREFOX_IOS="true"
                            BUILD_FOCUS_IOS="false"
                            BUILD_SAMPLE_BROWSER_IOS="true"
                            ;;
                        *)
                            # Default case - build all applications (e.g, BrowserKit)
                            BUILD_FIREFOX_IOS="true"
                            BUILD_FOCUS_IOS="true"
                            BUILD_SAMPLE_BROWSER_IOS="true"
                            ;;
                    esac
                done

                # Set environment variables
                envman add --key BUILD_FIREFOX_IOS --value "$BUILD_FIREFOX_IOS"
                envman add --key BUILD_FOCUS_IOS --value "$BUILD_FOCUS_IOS"
                envman add --key BUILD_SAMPLE_BROWSER_IOS --value "$BUILD_SAMPLE_BROWSER_IOS"

                echo "BUILD_FIREFOX_IOS: $BUILD_FIREFOX_IOS"
                echo "BUILD_FOCUS_IOS: $BUILD_FOCUS_IOS"
                echo "BUILD_SAMPLE_BROWSER_IOS: $BUILD_SAMPLE_BROWSER_IOS"

      - share-pipeline-variable@1:
          inputs:
            - variables: |-
                BUILD_FIREFOX_IOS
                BUILD_FOCUS_IOS
                BUILD_SAMPLE_BROWSER_IOS
      - script@1.2.1:
          title: Echo applications set
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex

                echo "BUILD_FIREFOX_IOS: $BUILD_FIREFOX_IOS"
                echo "BUILD_FOCUS_IOS: $BUILD_FOCUS_IOS"
                echo "BUILD_SAMPLE_BROWSER_IOS: $BUILD_SAMPLE_BROWSER_IOS"

  send_slack_notification:
    steps:
      - slack@4.2.1:
          inputs:
            - title: ""
            - author_name: ""
            - webhook_url: "$WEBHOOK_SLACK_TOKEN"
            - footer_icon: https://emoji.slack-edge.com/T027LFU12/testops-notify/d350cecb43e9e630.png
            - footer: Created by Mobile Test Engineering
            - pretext_on_error: "*Firefox-iOS* :firefox: *Build/XCUITests* :x:"
            - pretext: "*Firefox-iOS* :firefox: *Build/XCUITests* :white_check_mark:"
            - timestamp: "no"
            - fields: |
                Task | ${BITRISE_BUILD_URL}
                Owner | ${GIT_CLONE_COMMIT_AUTHOR_NAME}
                Commit | ${GIT_CLONE_COMMIT_MESSAGE_SUBJECT}
                Source-Workflow | ${BITRISE_TRIGGERED_WORKFLOW_TITLE}
                Branch | ${BITRISE_GIT_BRANCH}
                Warnings-in-code | ${SHOW_WARNING_COUNT}
                Warnings-in-code-test | ${SHOW_WARNING_COUNT_XCUI}
            - buttons: |
                App|${BITRISE_APP_URL}
                #mobile-testeng|https://mozilla.slack.com/archives/C02KDDS9QM9
                Mana|https://mana.mozilla.org/wiki/display/MTE/Mobile+Test+Engineering
  0_detect_standalone_build:
    steps:
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e

                # ANSI color codes
                RED='\033[31;1m'
                CYAN='\033[36;1m'
                GREEN='\033[32;1m'
                NC='\033[0m'        # No Color (resets color to default)

                # Check if $BITRISEIO_PIPELINE_ID is unset or empty
                # If so, this is a standalone build and we need to fail it
                if [ -z "$BITRISEIO_PIPELINE_ID" ]; then
                    printf "\n${RED}Error: BITRISEIO_PIPELINE_ID is not set.${NC}\n\
                    This means you have triggered a build stage or workflow individually, instead of the entire pipeline.\n\n\
                    The current build workflow is: ${RED}$BITRISE_TRIGGERED_WORKFLOW_TITLE${NC}, but needs to be run in ${RED}pipeline_build_and_test${NC}.\n\n\
                    To trigger a pipeline rebuild in its entirety, please do the following:\n\n\
                        ${CYAN}1. Select your last failed build for 'pipeline_build_and_test'.\n\
                        ${CYAN}2. Click the 'Rebuild' button dropdown icon located in the top right of the page.\n\
                        ${CYAN}3. From the dropdown menu, select 'Rebuild entire Pipeline'.\n\
                        ${CYAN}4. If no dropdown menu is present, you are looking at a standalone build\n\
                           ${CYAN}and need to select the initial Github pipeline triggered by the PR.${NC}\n\n\
                    If you are still having issues, please contact ${GREEN}#mobile-testeng${NC} on Slack.\n"
                    exit 1  # Exit with a failure status
                else
                    echo "BITRISEIO_PIPELINE_ID is set to $BITRISEIO_PIPELINE_ID"
                fi
          title: Detect standalone build
  1_git_clone_and_post_clone:
    steps:
      - activate-ssh-key@4.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@6.2: {}
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x
                BRANCH=$BITRISE_GIT_BRANCH

                if [[ $BRANCH == update-spm-new-rust-component-tag-* ]]
                then
                    echo "Building with new Rust-Component version"
                    envman add --key NEW_RC_VERSION --value New_RC_Version
                fi
          title: Save Branch Name
      - cache-pull@2.7.2: {}
  2_certificate_and_profile:
    steps:
      - certificate-and-profile-installer@1.11.4: {}
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x
                cd firefox-ios/Client.xcodeproj
                sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = "iPhone Developer"/' project.pbxproj
                cd -
          title: Set xcodeproj code_sign_identity to iPhone Developer
      - script@1.2.1:
          title: Pin swiftlint version to 0.62.2 (Workaround)
          inputs:
            - content: |-
                OLD_SWIFTLINT_PATH=`which swiftlint`
                curl -L -o swiftlint.zip https://github.com/realm/SwiftLint/releases/download/0.62.2/portable_swiftlint.zip
                unzip swiftlint.zip -d swiftlint_bin
                chmod +x swiftlint_bin/swiftlint
                sudo mv swiftlint_bin/swiftlint $OLD_SWIFTLINT_PATH
                which swiftlint
                swiftlint version
      - script@1.2.1:
          inputs:
            - content: |-
                ./bootstrap.sh
          title: Run bootstrap
      - swiftlint-extended@1.0.0:
          inputs:
            - linting_path: "$BITRISE_SOURCE_DIR"
            - lint_config_file: "" # Don't pass a config file to make use of nested configurations
      - deploy-to-bitrise-io@2.10.0: {}
      - script@1.2.1:
          inputs:
            - content: |-
                set -e
                echo "$SWIFTLINT_REPORT"
                if [ ! -z "$SWIFTLINT_REPORT" ] ;then
                # The file is not-empty.
                    echo "Failing build since there are swiftlint errors"
                    exit 1
                fi
          title: Fail build if swiftlint fails
  3_provisioning_and_npm_installation:
    steps:
      - script@1.2.1:
          title: NPM install and build
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                set -x

                npm install
                npm run build
  Detect_warnings:
    steps:
      - script@1.2.1:
          title: Detect number of warnings
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x

                TEST_LOG_PATH=$BITRISE_XCODEBUILD_TEST_LOG_PATH

                COUNT_XCUI=$(./test-fixtures/generate-metrics.sh $TEST_LOG_PATH all)
                envman add --key SHOW_WARNING_COUNT_XCUI --value "$COUNT_XCUI"

                envman add --key SHOW_WARNING_IN_SLACK --value Show_Warnings

                STR=$COUNT_XCUI
                SUB='greater'
                if [[ "$STR" == *"$SUB"* ]]; then
                    echo "Failure, the number of warnings increased"
                    exit 1
                fi
          is_always_run: true
  decision_to_run_UI_Tests:
    steps:
      - script@1.2.1:
          title: Files changed in commit
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -ex

                # We need to check both PRs and MERGEs for release and epic branches so an error isn't
                # created when trying to find a diff on a commit that doesn't exist on origin/main
                # First check destination branch for PRs and then check $BITRISE_GIT_BRANCH for
                # merges to origin/main since the destination branch changes back to origin/main
                if [[ $BITRISEIO_GIT_BRANCH_DEST = release* ]] || [[ $BITRISEIO_GIT_BRANCH_DEST = epic* ]]; then
                    FILES_CHANGED=$(git diff --name-only $BITRISEIO_GIT_BRANCH_DEST..."$BITRISE_GIT_COMMIT")
                elif [[ $BITRISE_GIT_BRANCH = release* ]] || [[ $BITRISE_GIT_BRANCH = epic* ]]; then
                    echo "Skipping Blacklist check for Merging into $BITRISE_GIT_BRANCH..."
                    exit 0
                    FILES_CHANGED=$(git diff --name-only $BITRISE_GIT_BRANCH..."$BITRISE_GIT_COMMIT")
                else
                    FILES_CHANGED=$(git diff --name-only origin/main..."$BITRISE_GIT_COMMIT")
                fi

                # Manual triggers leave empty commits.
                # Check for empty commit/PR and exit blacklist check if found to avoid erroring out.
                echo "Files changed in commit/PR: $FILES_CHANGED"
                if [[ -z "$FILES_CHANGED" ]]; then
                    echo "No files changed in commit/PR. Skipping Blacklist check..."
                    envman add --key RUN_UI_TESTS --value Run_UI_Tests
                    exit 0
                fi

                # Match on file names in all directories and subdirectories
                #
                # Project Configs
                #   .*[^bitrise]\.y[^/]*$ -> matches all files not named bitrise whose file extension begins with a 'y'
                #   .*\.sh$ -> matches all files whose file extension begins with 'sh'
                #   .*\.md$ -> matches all files whose file extension begins with 'md'
                #   .*\.lproj/.* -> matches all files whose parent directory begins with 'lproj'
                #   fastlane/* -> matches all files in the fastlane directory
                #   taskcluster/* -> matches all files in the taskcluster directory
                #
                # Features tested outside bitrise
                #   Sync*/* -> matches all files in the Sync, SyncTelemetry
                #   firefox-ios/firefox-ios-tests/Tests/Sync*/* -> matches all files in SyncIntegrationTests directories
                #   firefox-ios/firefox-ios-tests/Tests/L10nSnapshotTests/* -> matches all files in the L10nSnapshotTests directory
                #
                # Test Helpers
                #   test-fixtures/.py$ -> matches all files whose file extension begin with 'py'

                DO_NOT_RUN_TESTS='^(.*[^bitrise]\.y[^/]*$|.*\.sh$|.*\.md$|.*\.lproj/.*|Sync*/*|firefox-ios/firefox-ios-tests/Tests/Sync*/*|fastlane/*|taskcluster/*|firefox-ios/firefox-ios-tests/Tests/L10nSnapshotTests/*|test-fixtures/|focus-ios/|.*.py$)'

                # Pass the FILES_CHANGED to grep to find any matches for the regex DO_NOT_RUN_TESTS
                # -v inverts the filtered results, returning any files not filtered by the regex
                if grep -v -E "${DO_NOT_RUN_TESTS}" <<< "${FILES_CHANGED}" && [ -n "$FILES_CHANGED" ];
                then
                    echo "Running UI Tests"
                    envman add --key RUN_UI_TESTS --value Run_UI_Tests
                else
                    echo "Not Running UI Tests"
                fi
      - share-pipeline-variable@1.1.1:
          inputs:
            - variables: RUN_UI_TESTS
  NewXcodeVersions:
    steps:
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x

                YESTERDAY=`date -v -1d '+%Y-%m-%d'`

                brew install jq

                resp=$(curl -X GET -s -H 'Accept: application/vnd.github.v3+json' https://api.github.com/repos/mozilla-mobile/firefox-ios/commits\?sha\=main\&since\=$YESTERDAY | jq -r '.[].commit.message | select(contains("Auto Update Bitrise.YML"))')
                echo $resp
                if [ -z "$resp" ]
                then
                    echo "There is not any new commit, stop building"
                else
                    echo "There is a new commit, continue building"
                    envman add --key NEW_XCODE_VERSION --value New_Version_Found
                fi

                if [[ $BITRISE_GIT_MESSAGE == BuildAndRun* ]]
                then
                    echo "Scheduled build to run the rest of steps once xcode version has been updated"
                    envman add --key RUN_ALL_STEPS --value Run_All_Steps
                fi

          title: Check main branch for recent activity before continuing
      - activate-ssh-key@4.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@6.2: {}
      - cache-pull@2.7.2: {}
      - certificate-and-profile-installer@1.11.4: {}
      - script@1.2.1:
          run_if: '{{getenv "NEW_XCODE_VERSION" | eq "New_Version_Found" | or (getenv "RUN_ALL_STEPS" | eq "Run_All_Steps")}}'
          inputs:
            - content: |-
                ./bootstrap.sh
          title: Run bootstrap
      - script@1.2.1:
          run_if: '{{getenv "NEW_XCODE_VERSION" | eq "New_Version_Found" | or (getenv "RUN_ALL_STEPS" | eq "Run_All_Steps")}}'
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x

                cd firefox-ios/Client.xcodeproj
                sed -i '' 's/"Fennec Development"/"Bitrise Firefox iOS Dev"/' project.pbxproj
                sed -i '' 's/Fennec ShareTo Development/Bitrise Firefox iOS Dev - Share To/' project.pbxproj
                sed -i '' 's/Fennec WidgetKit Development/Bitrise Firefox iOS Dev - WidgetKit/' project.pbxproj
                sed -i '' 's/"XCUITests"/"Bitrise Firefox iOS Dev - XCUI Tests"/' project.pbxproj
                sed -i '' 's/Fennec NotificationService Development/Bitrise Firefox iOS Dev - Notification Service/' project.pbxproj
                sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = "iPhone Distribution"/' project.pbxproj
                cd -
          title: Set provisioning to Bitrise in xcodeproj
      - script@1.2.1:
          run_if: '{{getenv "NEW_XCODE_VERSION" | eq "New_Version_Found" | or (getenv "RUN_ALL_STEPS" | eq "Run_All_Steps")}}'
          title: NPM install and build
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                set -x

                npm install
                npm run build
      - xcode-build-for-simulator@3.0.0:
          run_if: '{{getenv "NEW_XCODE_VERSION" | eq "New_Version_Found" | or (getenv "RUN_ALL_STEPS" | eq "Run_All_Steps")}}'
          inputs:
            - xcodebuild_options: CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
            - scheme: Fennec
            - simulator_device: iPhone 17
      - xcode-test@6.0.0:
          run_if: '{{getenv "NEW_XCODE_VERSION" | eq "New_Version_Found" | or (getenv "RUN_ALL_STEPS" | eq "Run_All_Steps")}}'
          inputs:
            - scheme: Fennec
            - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
      - deploy-to-bitrise-io@2.10.0: {}
      - slack@4.2.1:
          run_if: '{{getenv "NEW_XCODE_VERSION" | eq "New_Version_Found" | or (getenv "RUN_ALL_STEPS" | eq "Run_All_Steps")}}'
          inputs:
            - channel: "#firefox-ios"
            - text: Build status using latest Xcode detected
            - message: "The build run info: $BITRISE_GIT_MESSAGE"
            - webhook_url: "$WEBHOOK_SLACK_TOKEN"
    description: This Workflow is to build the app using latest xcode available in Bitrise
    meta:
      bitrise.io:
        stack: osx-xcode-26.2.x-edge
        machine_type_id: g2.mac.4large
  L10nBuild:
    steps:
      - activate-ssh-key@4.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@6.2: {}
      - cache-pull@2.7.2: {}
      - certificate-and-profile-installer@1.11.4: {}
      - script@1.2.1:
          inputs:
            - content: |-
                ./bootstrap.sh firefox
          title: Run bootstrap
      - script@1.2.1:
          title: NPM install and build
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x

                npm install
                npm run build
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x
                gem install fastlane -v 2.226.0
                fastlane -version
                xcodebuild -version

                ./firefox-ios/l10n-screenshots.sh en-US
          title: Generate screenshots
      - save-cache@1.4.0:
          inputs:
            - key: l10n-screenshots-dd-$GIT_CLONE_COMMIT_HASH
            - paths: l10n-screenshots-dd
      - deploy-to-bitrise-io@2.10.0:
          inputs:
            - deploy_path: l10n-screenshots/en-US/en-US
            - is_compress: "true"
    envs:
      - opts:
          is_expand: false
        BITRISE_SCHEME: L10nSnapshotTest
    description: >-
      This Workflow is to run L10n tests in one locale and then share the bundle with
      the rest of the builds
  L10nScreenshotsTests:
    steps:
      - activate-ssh-key@4.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@6.2: {}
      - certificate-and-profile-installer@1.11.4: {}
      - restore-cache@2.5.0:
          inputs:
            - key: |-
                l10n-screenshots-dd-$GIT_CLONE_COMMIT_HASH
                l10n-screenshots-dd-
            - paths: l10n-screenshots-dd
          title: Download derived data path
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x
                gem install fastlane -v 2.226.0
                fastlane -version
                ./firefox-ios/l10n-screenshots.sh --test-without-building $MOZ_LOCALES

                mkdir -p artifacts

                for locale in $(echo $MOZ_LOCALES); do
                  zip -9 -j "$locale.zip" "l10n-screenshots/$locale/$locale/"*
                  mv "$locale.zip" artifacts/
                done
          title: Generate screenshots
      - deploy-to-bitrise-io@2.10.0:
          inputs:
            - deploy_path: artifacts/
    envs:
      - opts:
          is_expand: false
        BITRISE_SCHEME: L10nSnapshotTest
    description: >-
      This Workflow is to run L10n tests for all locales
  SPM_Deploy_Prod_Beta:
    before_run:
      - SPM_Common_Steps
    steps:
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x

                cd firefox-ios/Client.xcodeproj
                sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = "iPhone Distribution"/' project.pbxproj
                cd -
          title: Set xcodeproj code_sign_identity
      - script@1.2.1:
          title: NPM, ContentBlockerGen
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x

                ./bootstrap.sh
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_RELEASE_VERSION"
            - plist_path: firefox-ios/Client/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_RELEASE_VERSION"
            - plist_path: firefox-ios/Extensions/NotificationService/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_RELEASE_VERSION"
            - plist_path: firefox-ios/Extensions/ShareTo/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_RELEASE_VERSION"
            - plist_path: firefox-ios/WidgetKit/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_RELEASE_VERSION"
            - plist_path: firefox-ios/CredentialProvider/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_RELEASE_VERSION"
            - plist_path: firefox-ios/sticker/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_RELEASE_VERSION"
            - plist_path: firefox-ios/Extensions/ActionExtension/Info.plist
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x

                # write your script here

                echo "Setting Nimbus variables"
                /usr/libexec/PlistBuddy -c "Set NimbusURL $NIMBUS_URL" "firefox-ios/Client/Info.plist"
          title: Nimbus Variable Setup
      - xcode-archive@4.0:
          inputs:
            - project_path: firefox-ios/Client.xcodeproj
            - compile_bitcode: "no"
            - upload_bitcode: "no"
            - team_id: 43AQ936H96
            - export_method: app-store
            - output_tool: xcodebuild
            - distribution_method: app-store
            - export_development_team: 43AQ936H96
            - configuration: "$BITRISE_SCHEME"
      - deploy-to-bitrise-io@2.9.2: {}
      - deploy-to-itunesconnect-application-loader@1.3:
          inputs:
            - app_password: "$APPLE_ACCOUNT_PW"
            - password: "$APPLE_ACCOUNT_PW"
            - connection: "off"
            - itunescon_user: "$APPLE_ACCOUNT_ID"
      - script@1.2.1:
          title: Upload Firefox Prod Beta Symbols
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -x
                firefox-ios/ThirdParty/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN_FIREFOX" upload-dif \
                  --org mozilla --project firefox-ios "$BITRISE_DSYM_DIR_PATH"
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x
                # sleep 9999
          is_always_run: true
          title: debug-sleep
      - slack@3.2:
          inputs:
            - webhook_url: "$WEBHOOK_SLACK_TOKEN"
      - xcode-archive@4.0:
          inputs:
            - project_path: firefox-ios/Client.xcodeproj
            - compile_bitcode: "no"
            - upload_bitcode: "no"
            - team_id: 43AQ936H96
            - export_method: app-store
            - output_tool: xcodebuild
            - scheme: FirefoxBeta
            - export_development_team: 43AQ936H96
            - distribution_method: app-store
            - configuration: FirefoxBeta
          title: "FirefoxBeta: Xcode Archive & Export for iOS"
      - deploy-to-itunesconnect-application-loader@1.3:
          inputs:
            - app_password: "$APPLE_ACCOUNT_PW"
            - connection: "off"
            - itunescon_user: "$APPLE_ACCOUNT_ID"
          title: "FirefoxBeta: Deploy to iTunes Connect"
    envs:
      - opts:
          is_expand: false
        BITRISE_SCHEME: Firefox
    description: This step is to build, archive and upload Firefox Release and Beta

  SPM_Deploy_Beta_Only:
    before_run:
      - SPM_Common_Steps
    steps:
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x

                cd firefox-ios/Client.xcodeproj
                sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = "iPhone Distribution"/' project.pbxproj
                cd -
          title: Set xcodeproj code_sign_identity
      - script@1.2.1:
          title: NPM, ContentBlockerGen
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x

                ./bootstrap.sh
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_BETA_VERSION"
            - plist_path: firefox-ios/Client/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_BETA_VERSION"
            - plist_path: firefox-ios/Extensions/NotificationService/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_BETA_VERSION"
            - plist_path: firefox-ios/Extensions/ShareTo/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_BETA_VERSION"
            - plist_path: firefox-ios/WidgetKit/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_BETA_VERSION"
            - plist_path: firefox-ios/CredentialProvider/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_BETA_VERSION"
            - plist_path: firefox-ios/sticker/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_BETA_VERSION"
            - plist_path: firefox-ios/Extensions/ActionExtension/Info.plist
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x

                # write your script here
                echo "Setting Nimbus variables"
                /usr/libexec/PlistBuddy -c "Set NimbusURL $NIMBUS_URL" "firefox-ios/Client/Info.plist"
          title: Nimbus Variable Setup
      - xcode-archive@4.0:
          inputs:
            - project_path: firefox-ios/Client.xcodeproj
            - compile_bitcode: "no"
            - upload_bitcode: "no"
            - team_id: 43AQ936H96
            - export_method: app-store
            - output_tool: xcodebuild
            - scheme: FirefoxBeta
            - export_development_team: 43AQ936H96
            - distribution_method: app-store
            - configuration: FirefoxBeta
          title: "FirefoxBeta: Xcode Archive & Export for iOS"
      - deploy-to-itunesconnect-application-loader@1.3:
          inputs:
            - app_password: "$APPLE_ACCOUNT_PW"
            - connection: "off"
            - itunescon_user: "$APPLE_ACCOUNT_ID"
          title: "FirefoxBeta: Xcode Archive & Export for iOS"
      - script@1.2.1:
          title: Upload Firefox Beta Symbols
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -x
                firefox-ios/ThirdParty/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN_FIREFOX" upload-dif \
                  --org mozilla --project firefox-ios "$BITRISE_DSYM_DIR_PATH"
    envs:
      - opts:
          is_expand: false
        BITRISE_SCHEME: Firefox
    description: This step is to build, archive and upload Firefox Release and Beta

  SPM_Nightly_Beta_Only:
    steps:
      - activate-ssh-key@4.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@6.2: {}
      - certificate-and-profile-installer@1.11.4: {}
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -e
                set -x

                cd firefox-ios/Client.xcodeproj
                sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = "iPhone Distribution"/' project.pbxproj
                cd -
          title: Set xcodeproj code_sign_identity
      - script@1.2.1:
          title: NPM, ContentBlockerGen
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x

                ./bootstrap.sh
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
            - plist_path: firefox-ios/Client/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
            - plist_path: firefox-ios/Extensions/NotificationService/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
            - plist_path: firefox-ios/Extensions/ShareTo/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
            - plist_path: firefox-ios/WidgetKit/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
            - plist_path: firefox-ios/CredentialProvider/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
            - plist_path: firefox-ios/sticker/Info.plist
      - set-xcode-build-number@1:
          inputs:
            - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
            - plist_path: firefox-ios/Extensions/ActionExtension/Info.plist
      - script@1.2.1:
          inputs:
            - content: |-
                #!/usr/bin/env bash
                # fail if any commands fails
                set -e
                # debug log
                set -x

                # write your script here

                echo "Setting Nimbus variables"
                /usr/libexec/PlistBuddy -c "Set NimbusURL $NIMBUS_URL" "firefox-ios/Client/Info.plist"
          title: Nimbus Variable Setup
      - xcode-archive@4.0:
          inputs:
            - project_path: firefox-ios/Client.xcodeproj
            - compile_bitcode: "no"
            - upload_bitcode: "no"
            - team_id: 43AQ936H96
            - export_method: app-store
            - output_tool: xcodebuild
            - scheme: FirefoxBeta
            - export_development_team: 43AQ936H96
            - distribution_method: app-store
            - configuration: FirefoxBeta
          title: "FirefoxBeta: Xcode Archive & Export for iOS"
      - deploy-to-bitrise-io@2.9.2: {}
      - deploy-to-itunesconnect-application-loader@1.3:
          inputs:
            - app_password: "$APPLE_ACCOUNT_PW"
            - connection: "off"
            - itunescon_user: "$APPLE_ACCOUNT_ID"
          title: "Nightly FirefoxBeta: Xcode Archive & Export for iOS"
      - script@1.2.1:
          title: Upload NightlyBeta Symbols
          inputs:
            - content: |-
                #!/usr/bin/env bash
                set -x
                firefox-ios/ThirdParty/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN_FIREFOX" upload-dif \
                  --org mozilla --project firefox-ios "$BITRISE_DSYM_DIR_PATH"
    envs:
      - opts:
          is_expand: false
        BITRISE_SCHEME: Firefox
    description: This step is to build, archive and upload Firefox Release and Beta

  SPM_Common_Steps:
    steps:
      - activate-ssh-key@4.1.1:
          run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
      - git-clone@6.2: {}
      - certificate-and-profile-installer@1.11.4: {}
      - script@1.2.1:
          is_always_run: true
          title: Read version from version.txt file
          inputs:
            - content: |-
                #!/usr/bin/env bash
                pwd
                ls
                # Read and trim version string
                full_version=$(tr -d '[:space:]' < /Users/vagrant/git/version.txt)
                version=$(echo "$full_version" | sed -E 's/^([0-9]+(\.[0-9]+)*).*/\1/')
                echo "Version: $version"
                # Save version in BITRISE_RELEASE_VERSION
                envman add --key BITRISE_RELEASE_VERSION --value "$version"
                envman add --key BITRISE_BETA_VERSION --value "$version"
