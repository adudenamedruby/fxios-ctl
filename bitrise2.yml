  Bitrise_Performance_Test:
    steps:
    - cache-pull@2.7.2:
        is_always_run: true
    - xcode-test@6.0.0:
        inputs:
        - project_path: firefox-ios/Client.xcodeproj
        - scheme: Fennec
        - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
        - test_plan: PerformanceTestPlan
    - script@1.2.1:
        is_always_run: true
        title: Create perfherder data object
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x
            # get dependency
            cd ./test-fixtures && git clone https://github.com/clarmso/xcresult_extract.git

            echo $BITRISE_XCRESULT_PATH
            ls
            ls $BITRISE_XCRESULT_PATH

            cp -r $BITRISE_XCRESULT_PATH /Users/vagrant/Library/Developer/Xcode/DerivedData/**/Logs/Test/
            echo "DerivedData/Client/Log/Tests"
            ls /Users/vagrant/Library/Developer/Xcode/DerivedData
            CLIENT_PATH=$(ls /Users/vagrant/Library/Developer/Xcode/DerivedData | grep 'Client-')
            mv /Users/vagrant/Library/Developer/Xcode/DerivedData/$CLIENT_PATH/Logs/Test/Test-Fennec.xcresult /Users/vagrant/Library/Developer/Xcode/DerivedData/$CLIENT_PATH/Logs/Test/Test-Fennec-test.xcresult

            ls /Users/vagrant/Library/Developer/Xcode/DerivedData/$CLIENT_PATH/Logs/Test

            xcrun xcresulttool graph --path $BITRISE_XCRESULT_PATH --legacy
            ls ..
            python3 xcresult_extract/xcresult_extract.py -project ../Client.xcodeproj -scheme Fennec
            cat data.txt
            sed 's/.*=//;s/'\''/"/g' data.txt > test.json
            cat test.json
            python3 perfTestTransform.py
            mkdir -p "$BITRISE_DEPLOY_DIR"
            mv perfherder-data.json $BITRISE_DEPLOY_DIR
    - deploy-to-bitrise-io@2.10.0: {}
    before_run:
    - 1_git_clone_and_post_clone
    - 2_certificate_and_profile
    - 3_provisioning_and_npm_installation
  Archive_and_Run_Robo_Test:
    before_run:
    - 1_git_clone_and_post_clone
    - 2_certificate_and_profile
    - 3_provisioning_and_npm_installation
    steps:
    - xcode-archive@5.4.0:
        inputs:
        - project_path: firefox-ios/Client.xcodeproj
        - compile_bitcode: 'no'
        - upload_bitcode: 'no'
        - team_id: 9G8J6YA743
        - export_method: development
        - distribution_method: development
        - export_development_team: 9G8J6YA743
        - output_tool: xcodebuild
        - scheme: Fennec_Enterprise
        - configuration: Fennec_Enterprise
    - deploy-to-bitrise-io@2.10.0: {}
    - script@1.2.1:
        title: Update Google Cloud SDK Components
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            gcloud components install beta --quiet
            gcloud components update --quiet
    - script@1.2.1:
        title: Firebase Test Lab Execution
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            set -o pipefail

            curl -o /tmp/key-file.json $BITRISEIO_GOOGLE_APPLICATION_CREDENTIALS_URL
            gcloud version
            gcloud auth activate-service-account -q --key-file /tmp/key-file.json
            gcloud config set project "$GOOGLE_CLOUD_PROJECT"
            GCLOUD_OUTPUT=$(gcloud beta firebase test ios run \
                --type robo \
                --app "$BITRISE_IPA_PATH" \
                --device=model=iphone14pro,version=16.6 \
                --results-bucket=firefox_ios_test_artifacts \
                --no-record-video \
                --timeout=10m \
                --client-details=matrixLabel="Bitrise" \
                --quiet 2>&1)

            GCLOUD_EXITCODE=$? # this will get the right-most command from the gcloud subshell
            echo "GCLOUD_EXITCODE: $GCLOUD_EXITCODE"

            # There is a chance the gcloud cli returns a custom array of exit codes, so we will need
            #    to parse the output to get the exit codes and potentially trigger our own failure
            # In the case of an Inconclusive Test, we still haven't confirmed what stand-in exit code
            #   is returned, so we will need to update this script once we know what it is.
            # We also don't know what order the exit codes will be returned in, so we will need to
            #   parse the output to get the exit codes and then assign them to variables.

            envman add --key GCLOUD_EXIT_CODE --value "$GCLOUD_EXITCODE"
            MATRIX_WEBLINK=$(echo "$GCLOUD_OUTPUT" | grep 'https://console.firebase.google.com/project' | awk -F '[][]' '{print $2}' | head -n 1)
            envman add --key MATRIX_WEBLINK --value "$MATRIX_WEBLINK"
    - script@1.2.1:
        title: Modify Slack Message Based on GCLOUD_EXIT_CODE
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # unpack GLCOUD_EXIT_CODE from string to int, if gcloud returns string instead of int for exit code
            if [ $((GCLOUD_EXIT_CODE)) -ne 0 ]; then
                SLACK_MESSAGE_PRETEXT="*Firefox-iOS* :firefox: *Archive/Robo Test* :x:"
            else
                SLACK_MESSAGE_PRETEXT="*Firefox-iOS* :firefox: *Archive/Robo Test* :white_check_mark:"
            fi
            envman add --key SLACK_MESSAGE_PRETEXT --value "$SLACK_MESSAGE_PRETEXT"
    - slack@4.2.1:
        is_always_run: true
        inputs:
        - title: ''
        - author_name: ''
        - webhook_url: "$WEBHOOK_SLACK_TOKEN"
        - footer_icon: https://emoji.slack-edge.com/T027LFU12/testops-notify/d350cecb43e9e630.png
        - footer: Created by Mobile Test Engineering
        - pretext_on_error: "${SLACK_MESSAGE_PRETEXT}"
        - pretext: "${SLACK_MESSAGE_PRETEXT}"
        - timestamp: 'no'
        - fields: |
            Task | ${BITRISE_BUILD_URL}
            Commit | ${GIT_CLONE_COMMIT_MESSAGE_SUBJECT}
            Source-Workflow | ${BITRISE_TRIGGERED_WORKFLOW_TITLE}
            Branch | ${BITRISE_GIT_BRANCH}
            Result | ${MATRIX_WEBLINK}
        - buttons: |
            App|${BITRISE_APP_URL}
            #mobile-testeng|https://mozilla.slack.com/archives/C02KDDS9QM9
            Mana|https://mana.mozilla.org/wiki/display/MTE/Mobile+Test+Engineering
  Firebase_Performance_Test:
    before_run:
    - 1_git_clone_and_post_clone
    - 2_certificate_and_profile
    - 3_provisioning_and_npm_installation
    steps:
    - xcode-archive@5.4.0:
        inputs:
        - project_path: firefox-ios/Client.xcodeproj
        - compile_bitcode: 'no'
        - upload_bitcode: 'no'
        - team_id: 9G8J6YA743
        - export_method: development
        - distribution_method: development
        - export_development_team: 9G8J6YA743
        - output_tool: xcodebuild
        - scheme: Fennec_Enterprise
        - configuration: Fennec_Enterprise
        - xcconfig_content: ENABLE_DEBUG_DYLIB=NO
    - deploy-to-bitrise-io@2.10.0: {}
    - script@1.2.1:
        title: Firebase Build for Testing Physical Devices
        inputs:
        - content: |
            #!/usr/bin/env bash
            set -euxo pipefail

            DERIVED_DATA_DIR="/Users/vagrant/git/DerivedData"
            PROJECT="/Users/vagrant/git/firefox-ios/Client.xcodeproj"
            SCHEME="Fennec_Enterprise"
            SDK="iphoneos"
            IOS_VERSION="18.2"
            DESTINATION="generic/platform=iOS"
            PRODUCTS_DIR="${DERIVED_DATA_DIR}/Build/Products"
            TEST_PLAN="${SCHEME}_PerformanceTestPlan"

            echo "-- build-for-testing --"
            mkdir DerivedData
            xcodebuild -resolvePackageDependencies -onlyUsePackageVersionsFromResolvedFile -project firefox-ios/Client.xcodeproj
            xcodebuild build-for-testing -project "$PROJECT" \
                -scheme "$SCHEME" \
                -sdk "$SDK$IOS_VERSION" \
                -destination "$DESTINATION" \
                -derivedDataPath "${DERIVED_DATA_DIR}" \
                ENABLE_DEBUG_DYLIB=NO

            echo "-- verify build artifacts --"

            if [[ ! -d "$PRODUCTS_DIR" ]]; then
                echo "Error: $PRODUCTS_DIR was not created. Check your build steps and try again."
                exit 1
            fi

            if [[ -z $(find "$PRODUCTS_DIR" -type f -name "${TEST_PLAN}*.xctestrun") ]]; then
                echo "Error: Missing $TEST_PLAN. Check your scheme and ensure the Test Plan is added."
                echo "The files in $PRODUCTS_DIR are:"
                ls -l "$PRODUCTS_DIR"
                echo "The available test plans for this scheme, $SCHEME, are:"
                awk '/<TestPlanReference/,/<\/TestPlanReference>/' \
                    "${PROJECT}/xcshareddata/xcschemes/${SCHEME}.xcscheme" | \
                    grep "reference" | \
                    cut -d '"' -f 2 | \
                    sed -n 's|container:Tests/\(.*\).xctestplan|\1|p'
                exit 1
            fi

            if [[ ! -d "${PRODUCTS_DIR}/${SCHEME}-${SDK}" ]]; then
                echo "Error: Missing sdk for iPhone OS. Check your build sdk argument and try again."
                echo "The files in $PRODUCTS_DIR are:"
                ls -l "$PRODUCTS_DIR"
                echo "The available sdks in this environment are:"
                xcodebuild -showsdks | grep -E 'iphoneos|iphonesimulator'
                exit 1
            fi
    - script@1.2.1:
        title: Create .zip artifact for Firebase Testing
        inputs:
        - content: |
            #!/usr/bin/env bash
            set -euxo pipefail

            PRODUCTS_DIR="/Users/vagrant/git/DerivedData/Build/Products"
            SCHEME="Fennec_Enterprise"
            SDK="iphoneos"
            TEST_PLAN="${SCHEME}_PerformanceTestPlan"
            TARGET_ARCHIVE="/Users/vagrant/git/Fennec_Enterprise.zip"

            echo "-- create .zip artifact --"
            # do not double-quote $TEST_PLAN, as it is a wildcard and we need it to expand
            ( cd "$PRODUCTS_DIR" && zip -r "${SCHEME}.zip" "${SCHEME}-${SDK}" ${TEST_PLAN}*.xctestrun )
            mv "${PRODUCTS_DIR}/${SCHEME}.zip" "$TARGET_ARCHIVE"
    - cache-pull@2.7.2:
        inputs:
        - cache_paths: "$HOME/google-cloud-sdk"
    - script@1.2.1:
        title: Install Google Cloud SDK
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -e

            if [ -e $HOME/google-cloud-sdk ]; then
              echo "Google Cloud SDK found, skipping installation..."
            else
              echo "Google Cloud SDK not found, installing..."
              curl https://sdk.cloud.google.com > install.sh
              bash install.sh --disable-prompts
              source $HOME/google-cloud-sdk/path.bash.inc
            fi
    - script@1.2.1:
        title: Pin Python version
        inputs:
        - content: |-
            brew unlink python@3.12
            brew unlink python@3.11
            brew link --force python@3.11
    - cache-push@2.7.1:
        inputs:
        - cache_paths: "$HOME/google-cloud-sdk"
        - ignore_check_on_paths: "!/Users/vagrant/Library/Developer/Xcode/DerivedData/**"
        - compress_archive: "true"
    - script@1.2.1:
        title: Run Performance Tests in Firebase Test Lab
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            TIMESTAMP=$(date "+%Y%m%d%H%M%S")
            RESULTS_DIR="firefox_ios_performance_tests_${TIMESTAMP}"
            GOOGLE_CLOUD_BUCKET="firefox_ios_test_artifacts"
            DEVICE_MODEL="iphone15pro" # if updating device model and version, also update firebase-performance.kind
            DEVICE_VERSION="18.0"
            XCRESULT_PATH="gs://${GOOGLE_CLOUD_BUCKET}/${RESULTS_DIR}/${DEVICE_MODEL}-${DEVICE_VERSION}-en-portrait/TestLogs/"
            TARGET_ARCHIVE="/Users/vagrant/git/Fennec_Enterprise.zip" # this should be the same as the artifact created in the previous step

            curl -o /tmp/key-file.json "$BITRISEIO_GOOGLE_APPLICATION_CREDENTIALS_URL"
            $HOME/google-cloud-sdk/bin/gcloud version
            $HOME/google-cloud-sdk/bin/gcloud auth activate-service-account -q --key-file /tmp/key-file.json
            $HOME/google-cloud-sdk/bin/gcloud config set project "$GOOGLE_CLOUD_PROJECT"

            FIREBASE_TEST_RESULT=$($HOME/google-cloud-sdk/bin/gcloud firebase test ios run \
                --test "$TARGET_ARCHIVE" \
                --xcode-version=16.2 \
                --device model="$DEVICE_MODEL",version="$DEVICE_VERSION" \
                --client-details=matrixLabel="Bitrise" \
                --num-flaky-test-attempts=2 \
                --results-bucket="$GOOGLE_CLOUD_BUCKET" \
                --results-dir="$RESULTS_DIR")

            FIREBASE_XCRESULT_PATH=$("${HOME}/google-cloud-sdk/bin/gsutil" ls "$XCRESULT_PATH" | grep ".xcresult")
            envman add --key FIREBASE_XCRESULT_PATH --value "$FIREBASE_XCRESULT_PATH"
    - script@1.2.1:
        is_always_run: true
        title: Create Perfherder Data Object from Firebase
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -ex

            # get dependency
            cd ./test-fixtures && git clone https://github.com/clarmso/xcresult_extract.git

            # pull firebase xcresult and rename it to extract measurement data
            mkdir test_firebase_xcresult

            $HOME/google-cloud-sdk/bin/gsutil -m cp -r "$FIREBASE_XCRESULT_PATH" ./test_firebase_xcresult &

            # Get the process ID of the backgrounded gsutil command
            PID=$!

            TIMEOUT=60
            CHECK_INTERVAL=5
            ITERATIONS=$((TIMEOUT / CHECK_INTERVAL))

            for ((i = 0; i < ITERATIONS; i++)); do
                echo "Waiting for gsutil to complete..."
                sleep $CHECK_INTERVAL
                if ! ps -p $PID > /dev/null; then
                    break
                fi
            done

            # if gsutil is still running after 60s, it is hanging and needs to be killed
            if ps -p $PID > /dev/null; then
                echo "The gsutil command exceeded the timeout. Stopping and removing contents..."
                kill -9 $PID

                rm -rf ./test_firebase_xcresult
                mkdir ./test_firebase_xcresult
                echo "Retrying xcresult copy without multi-processing..."
                $HOME/google-cloud-sdk/bin/gsutil cp -r "$FIREBASE_XCRESULT_PATH" ./test_firebase_xcresult
            fi

            mv ./test_firebase_xcresult/*.xcresult ./test_firebase_xcresult/Test-Fennec-test.xcresult

            # firebase xcresult needs to be in the Test dir created during earlier build-for-testing step
            FIREBASE_XCRESULT="./test_firebase_xcresult/Test-Fennec-test.xcresult"
            CLIENT_PATH=$(ls /Users/vagrant/Library/Developer/Xcode/DerivedData | grep 'Client-')
            BITRISE_XCRESULT="/Users/vagrant/Library/Developer/Xcode/DerivedData/${CLIENT_PATH}/Logs/Test/Test-Fennec-test.xcresult"
            mv "$FIREBASE_XCRESULT" "$BITRISE_XCRESULT"

            # create and print perf data object for perfherder ingest via taskcluster log output
            xcrun xcresulttool graph --path "$BITRISE_XCRESULT" --legacy
            ls ..
            # If this ever breaks, check the xcresult_extract.py function find_xcresult_path
            # and figure out exactly what it is doing because we are using Fennec as the scheme
            # and it works for both Fennec and Fennec_Enterprise, but I don't know why.
            # I would change it here but I am too afraid to break it.
            python3 xcresult_extract/xcresult_extract.py -project ../Client.xcodeproj -scheme Fennec
            cat data.txt
            sed 's/.*=//;s/'\''/"/g' data.txt > test.json
            cat test.json
            python3 perfTestTransform.py
            mkdir -p "$BITRISE_DEPLOY_DIR"
            mv perfherder-data.json $BITRISE_DEPLOY_DIR
    - deploy-to-bitrise-io@2.10.0: {}
    meta:
      bitrise.io:
        stack: osx-xcode-16.2.x
        machine_type_id: g2.mac.4large

  Firefox_Unit_Tests:
    before_run:
    - 1_git_clone_and_post_clone
    - 2_certificate_and_profile
    - 3_provisioning_and_npm_installation
    steps:
    - xcode-test@6.0.1:
        timeout: 6000
        inputs:
        - project_path: firefox-ios/Client.xcodeproj
        - scheme: Fennec
        - configuration: Fennec_Testing
        - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
        - test_plan: UnitTest
        - test_repetition_mode: until_failure
        - maximum_test_repetitions: 3
        - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO" "CODE_SIGN_IDENTITY=" "CODE_SIGNING_REQUIRED=NO" "CODE_SIGNING_ALLOWED=NO" "-parallel-testing-enabled" "NO" "-parallel-testing-worker-count" "2"'
    - deploy-to-bitrise-io@2.10.0: {}

  #
  # *****%*****%***** FOCUS WORKFLOWS *****%*****%*****
  #
  focus_configure_build:
    before_run:
    - focus-clone-and-build-dependencies
    steps:
    - cache-pull@2.7.2: {}
    #- swiftlint-extended@1:
    #    inputs:
    #    - linting_path: "$BITRISE_SOURCE_DIR"
    - script@1.2.1:
        title: Set Default Web Browser Entitlement
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            /usr/libexec/PlistBuddy -c "Add :com.apple.developer.web-browser bool true" Klar.entitlements
    - xcode-build-for-test@3:
        inputs:
        - scheme: Focus
        - configuration: FocusDebug
        - project_path: /Users/vagrant/git/focus-ios/Blockzilla.xcodeproj
        - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO" "CODE_SIGN_IDENTITY=" "CODE_SIGNING_REQUIRED=NO" "CODE_SIGNING_ALLOWED=NO"'
        - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
    - script@1.2.1:
        title: Override xctestrun Focus env variables
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -euxo pipefail
            # Point to the Unit tests plan instead of Accessibility
            FOCUS_UI_XCTESTRUN="$BITRISE_TEST_BUNDLE_PATH/Focus_SmokeTest_iphonesimulator26.1-arm64.xctestrun"

            echo "Found UITest .xctestrun: $FOCUS_UI_XCTESTRUN"
            envman add --key BITRISE_XCTESTRUN_FOCUS_UI_TEST_FILE_PATH --value "$FOCUS_UI_XCTESTRUN"
    - xcode-test-without-building@0.5.1:
        timeout: 1200
        inputs:
        - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
        - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO" "CODE_SIGN_IDENTITY=" "CODE_SIGNING_REQUIRED=NO" "CODE_SIGNING_ALLOWED=NO"'
        - xctestrun: $BITRISE_TEST_BUNDLE_PATH/Focus_UnitTests_iphonesimulator26.1-arm64.xctestrun
    - xcode-test-shard-calculation@0:
        inputs:
        - product_path: $BITRISE_XCTESTRUN_FOCUS_UI_TEST_FILE_PATH
        - shard_count: 1
        - destination: $BITRISE_DESTINATION
    - deploy-to-bitrise-io@2.10.0:
        inputs:
        - pipeline_intermediate_files: |-
            BITRISE_TEST_BUNDLE_PATH
            BITRISE_TEST_SHARDS_PATH
            BITRISE_XCTESTRUN_FOCUS_UI_TEST_FILE_PATH
    - slack@4.2.1:
        run_if: ".IsBuildFailed"
        inputs:
        - channel: "#mobile-alerts-ios"
        - message: "The build failed to build"
        - webhook_url: "$SLACK_WEBHOOK"

  klar_configure_build:
    before_run:
    - focus-clone-and-build-dependencies
    steps:
    - cache-pull@2.7.2: {}
    #- swiftlint-extended@1:
    #    inputs:
    #    - linting_path: "$BITRISE_SOURCE_DIR"
    - script@1.2.1:
        title: Set Default Web Browser Entitlement
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            /usr/libexec/PlistBuddy -c "Add :com.apple.developer.web-browser bool true" Klar.entitlements
    - xcode-build-for-test@3:
        inputs:
        - scheme: Klar
        - configuration: KlarDebug
        - project_path: /Users/vagrant/git/focus-ios/Blockzilla.xcodeproj
        - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO" "CODE_SIGN_IDENTITY=" "CODE_SIGNING_REQUIRED=NO" "CODE_SIGNING_ALLOWED=NO"'
        - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
    - xcode-test-without-building@0.5.1:
        timeout: 1200
        inputs:
        - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
        - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO" "CODE_SIGN_IDENTITY=" "CODE_SIGNING_REQUIRED=NO" "CODE_SIGNING_ALLOWED=NO"'
        - xctestrun: $BITRISE_TEST_BUNDLE_PATH/Klar_UnitTests_iphonesimulator26.1-arm64.xctestrun
    - deploy-to-bitrise-io@2.10.0: {}
    - slack@4.2.1:
        run_if: ".IsBuildFailed"
        inputs:
        - channel: "#mobile-alerts-ios"
        - message: "The build run the Klar testPlan: UnitTests"
        - webhook_url: "$SLACK_WEBHOOK"
  focus_ui_test:
    steps:
    - script@1.2.1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            # fail if any commands fails
            set -e
            # debug log
            set -x
            # Check if it is a scheduled or regular build
            # to select the testPlan to run

            if [[ $BITRISE_GIT_MESSAGE == Schedule* ]]
            then
                echo "Scheduled build, running Full Functional Tests"
                envman add --key TEST_PLAN_NAME --value FullFunctionalTests
            else
                echo "Regular build, running Smoke Test"
                envman add --key TEST_PLAN_NAME --value SmokeTest
            fi
        - title: Check if build is scheduled or regular to set the test plan
    - pull-intermediate-files@1: {}
    - xcode-test-without-building@0.5.1:
        timeout: 1200
        inputs:
        - only_testing: $BITRISE_TEST_SHARDS_PATH/$BITRISE_IO_PARALLEL_INDEX
        - destination: platform=iOS Simulator,name=iPhone 17,OS=26.1
        - xcodebuild_options: '"COMPILER_INDEX_STORE_ENABLE=NO" "CODE_SIGN_IDENTITY=" "CODE_SIGNING_REQUIRED=NO" "CODE_SIGNING_ALLOWED=NO"'
        - xctestrun: $BITRISE_TEST_BUNDLE_PATH/Focus_SmokeTest_iphonesimulator26.1-arm64.xctestrun
    - deploy-to-bitrise-io@2.10.0: {}
    - github-status@3.0.1:
        inputs:
        - status_identifier: "Focus-build"
    - slack@4.2.1:
        run_if: ".IsBuildFailed"
        inputs:
        - channel: "#mobile-alerts-ios"
        - message: "The build run the Focus testPlan: $TEST_PLAN_NAME"
        - webhook_url: "$SLACK_WEBHOOK"

  # # FOCUS UTILITIES WORKFLOWS
  focus-clone-and-build-dependencies:
    description: Clones the repo and builds dependencies
    before_run:
    - SPM_Common_Steps
    steps:
    - script@1.2.1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            ./bootstrap.sh focus
        title: ContentBlockerGen

  focus-set-project-version:
    steps:
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: focus-ios/Blockzilla/Info.plist
        title: Set Blockzilla version numbers
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: focus-ios/ContentBlocker/Info.plist
        title: Set ContentBlocker version numbers
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: focus-ios/FocusIntentExtension/Info.plist
        title: Set FocusIntentExtension version numbers
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: focus-ios/OpenInFocus/Info.plist
        title: Set OpenInFocus version numbers

  focus-configure-nimbus:
    steps:
    - script@1.2.1:
        title: Configure Nimbus
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            /usr/libexec/PlistBuddy -c "Add :NimbusServerURL string ${NIMBUS_SERVER_URL}" focus-ios/Blockzilla/Info.plist
            /usr/libexec/PlistBuddy -c "Add :NimbusStagingServerURL string ${NIMBUS_STAGING_SERVER_URL}" focus-ios/Blockzilla/Info.plist
            /usr/libexec/PlistBuddy -c "Set :NimbusAppName ${NIMBUS_APP_NAME}" focus-ios/Blockzilla/Info.plist
            /usr/libexec/PlistBuddy -c "Set :NimbusAppChannel ${NIMBUS_APP_CHANNEL}" focus-ios/Blockzilla/Info.plist

  focus-configure-sentry:
    steps:
    - script@1.2.1:
        title: Configure Sentry
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            /usr/libexec/PlistBuddy -c "Add :SentryDSN string ${SENTRY_DSN_FOCUS}" focus-ios/Blockzilla/Info.plist

  focus-set-default-browser-entitlement:
    steps:
    - script@1.2.1:
        title: Set Default Web Browser Entitlement
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            /usr/libexec/PlistBuddy -c "Add :com.apple.developer.web-browser bool true" focus-ios/Focus.entitlements
            /usr/libexec/PlistBuddy -c "Add :com.apple.developer.web-browser bool true" focus-ios/Klar.entitlements

  # # Update the name change in Taskcluster files
  # focus_l10n_build:
  #   before_run:
  #   - focus-clone-and-build-dependencies
  #   steps:
  #   - script@1:
  #       title: Set Default Web Browser Entitlement
  #       inputs:
  #       - content: |-
  #           #!/usr/bin/env bash
  #           set -x
  #           /usr/libexec/PlistBuddy -c "Add :com.apple.developer.web-browser bool true" focus-ios/Focus.entitlements
  #           /usr/libexec/PlistBuddy -c "Add :com.apple.developer.web-browser bool true" focus-ios/Klar.entitlements
  #   - script@1:
  #       title: Generate screenshots
  #       inputs:
  #       - content: |-
  #           #!/usr/bin/env bash
  #           set -x
  #           # workaround until 2.187 version is installed. Error with 2.186
  #           ./focus-ios/focus-ios-tests/l10n-screenshots.sh en-US
  #   - deploy-to-bitrise-io@1.10:
  #       inputs:
  #       - deploy_path: l10n-screenshots-dd/
  #       - is_compress: 'true'
  #   - deploy-to-bitrise-io@1.10:
  #       inputs:
  #       - deploy_path: l10n-screenshots/en-US/en-US
  #       - is_compress: 'true'

  # focus_l10n_screenshots_tests:
  #   steps:
  #   - activate-ssh-key@4:
  #       run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
  #   - git-clone@6.2: {}
  #   - cache-pull@2: {}
  #   - certificate-and-profile-installer@1: {}
  #   - script@1:
  #       title: Set Default Web Browser Entitlement
  #       inputs:
  #       - content: |-
  #           #!/usr/bin/env bash
  #           set -x
  #           /usr/libexec/PlistBuddy -c "Add :com.apple.developer.web-browser bool true" focus-ios/Focus.entitlements
  #           /usr/libexec/PlistBuddy -c "Add :com.apple.developer.web-browser bool true" focus-ios/Klar.entitlements
  #   - script@1:
  #       inputs:
  #       - content: >-
  #           #!/usr/bin/env bash
  #           # fail if any commands fails
  #           set -e

  #           # debug log
  #           set -x

  #           echo "curl to Download derived data"
  #           curl --location --retry 5 --output l10n-screenshots-dd.zip "$MOZ_DERIVED_DATA_PATH"
  #           mkdir l10n-screenshots-dd
  #           unzip l10n-screenshots-dd.zip -d l10n-screenshots-dd
  #           rm l10n-screenshots-dd.zip
  #       title: Download derived data path
  #   - script@1:
  #       title: Generate screenshots
  #       inputs:
  #       - content: |-
  #           #!/usr/bin/env bash
  #           # fail if any commands fails
  #           set -e
  #           # debug log
  #           set -x
  #           # workaround until 2.187 version is installed. Error with 2.186
  #           ./focus-ios/focus-ios-tests/l10n-screenshots.sh --test-without-building $MOZ_LOCALES
  #           mkdir -p artifacts

  #           for locale in $(echo $MOZ_LOCALES); do
  #             # Only Focus for now
  #             zip -9 -j "$locale.zip" "l10n-screenshots/$locale/$locale/"*
  #             mv "$locale.zip" artifacts/
  #           done
  #   - deploy-to-bitrise-io@1.10:
  #       inputs:
  #       - deploy_path: artifacts/

  # # FOCUS RELEASE WORKFLOWS
  focus_SPM_Beta:
    before_run:
    - focus-clone-and-build-dependencies
    - focus-set-default-browser-entitlement
    - focus-configure-nimbus
    - focus-configure-sentry
    steps:
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_BETA_VERSION"
        - plist_path: focus-ios/Blockzilla/Info.plist
        title: Set Blockzilla version numbers
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_BETA_VERSION"
        - plist_path: focus-ios/ContentBlocker/Info.plist
        title: Set ContentBlocker version numbers
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_BETA_VERSION"
        - plist_path: focus-ios/FocusIntentExtension/Info.plist
        title: Set FocusIntentExtension version numbers
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_BETA_VERSION"
        - plist_path: focus-ios/OpenInFocus/Info.plist
        title: Set OpenInFocus version numbers
    - certificate-and-profile-installer@1: {}
    - xcode-archive@3:
        inputs:
        - project_path: focus-ios/Blockzilla.xcodeproj
        - scheme: Focus
        - team_id: 43AQ936H96
        - export_method: app-store
        title: Build Focus
    - deploy-to-itunesconnect-application-loader@1:
        inputs:
        - connection: 'off'
        - app_password: "$APPLE_ACCOUNT_PW"
        - itunescon_user: "$APPLE_ACCOUNT_ID"
    - script@1.2.1:
        title: Upload Focus Symbols
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            focus-ios/focus-ios-tests/tools/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN" upload-dif \
              --org mozilla --project focus-ios "$BITRISE_DSYM_DIR_PATH"
    - xcode-archive@3:
        inputs:
        - project_path: focus-ios/Blockzilla.xcodeproj
        - scheme: Klar
        - export_method: app-store
        title: Build Klar
    - deploy-to-itunesconnect-application-loader@1:
        inputs:
        - connection: 'off'
        - app_password: "$APPLE_ACCOUNT_PW"
        - itunescon_user: "$APPLE_ACCOUNT_ID"
    - script@1.2.1:
        title: Upload Klar Symbols
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            focus-ios/focus-ios-tests/tools/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN" upload-dif \
              --org mozilla --project klar-ios "$BITRISE_DSYM_DIR_PATH"

  focus_SPM_Nightly:
    before_run:
    - focus-clone-and-build-dependencies
    - focus-set-default-browser-entitlement
    - focus-configure-nimbus
    - focus-configure-sentry
    steps:
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
        - plist_path: focus-ios/Blockzilla/Info.plist
        title: Set Blockzilla version numbers
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
        - plist_path: focus-ios/ContentBlocker/Info.plist
        title: Set ContentBlocker version numbers
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
        - plist_path: focus-ios/FocusIntentExtension/Info.plist
        title: Set FocusIntentExtension version numbers
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_NIGHTLY_VERSION"
        - plist_path: focus-ios/OpenInFocus/Info.plist
        title: Set OpenInFocus version numbers
    - certificate-and-profile-installer@1.11.4: {}
    - xcode-archive@3:
        inputs:
        - project_path: focus-ios/Blockzilla.xcodeproj
        - scheme: Focus
        - team_id: 43AQ936H96
        - export_method: app-store
        title: Build Focus
    - deploy-to-itunesconnect-application-loader@1:
        inputs:
        - connection: 'off'
        - app_password: "$APPLE_ACCOUNT_PW"
        - itunescon_user: "$APPLE_ACCOUNT_ID"
    - script@1.2.1:
        title: Upload Focus Symbols
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            focus-ios/focus-ios-tests/tools/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN" upload-dif \
              --org mozilla --project focus-ios "$BITRISE_DSYM_DIR_PATH"
    - xcode-archive@3:
        inputs:
        - project_path: focus-ios/Blockzilla.xcodeproj
        - scheme: Klar
        - export_method: app-store
        title: Build Klar
    - deploy-to-itunesconnect-application-loader@1:
        inputs:
        - connection: 'off'
        - app_password: "$APPLE_ACCOUNT_PW"
        - itunescon_user: "$APPLE_ACCOUNT_ID"
    - script@1.2.1:
        title: Upload Klar Symbols
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            focus-ios/focus-ios-tests/tools/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN" upload-dif \
              --org mozilla --project klar-ios "$BITRISE_DSYM_DIR_PATH"

  focus_release:
    before_run:
    - focus-clone-and-build-dependencies
    - focus-set-project-version
    - focus-set-default-browser-entitlement
    - focus-configure-nimbus
    - focus-configure-sentry
    steps:
    - certificate-and-profile-installer@1: {}
    - xcode-archive@3:
        inputs:
        - project_path: focus-ios/Blockzilla.xcodeproj
        - scheme: Focus
        - team_id: 43AQ936H96
        - export_method: app-store
        title: Build Focus
    - deploy-to-itunesconnect-application-loader@1:
        inputs:
        - connection: 'off'
        - app_password: "$APPLE_ACCOUNT_PW"
        - itunescon_user: "$APPLE_ACCOUNT_ID"
    - script@1.2.1:
        title: Upload Focus Symbols
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            focus-ios/focus-ios-tests/tools/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN" upload-dif \
              --org mozilla --project focus-ios "$BITRISE_DSYM_DIR_PATH"
    - xcode-archive@3:
        inputs:
        - project_path: focus-ios/Blockzilla.xcodeproj
        - scheme: Klar
        - export_method: app-store
        title: Build Klar
    - deploy-to-itunesconnect-application-loader@1:
        inputs:
        - connection: 'off'
        - app_password: "$APPLE_ACCOUNT_PW"
        - itunescon_user: "$APPLE_ACCOUNT_ID"
    - script@1.2.1:
        title: Upload Klar Symbols
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -x
            focus-ios/focus-ios-tests/tools/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN" upload-dif \
              --org mozilla --project klar-ios "$BITRISE_DSYM_DIR_PATH"

# RelPro workflows
  release_promotion_promote_focus:
    before_run:
    - focus-clone-and-build-dependencies
    - focus-set-project-version
    - focus-set-default-browser-entitlement
    - focus-configure-nimbus
    - focus-configure-sentry
    steps:
    - script@1.2.1:
        title: Override default bitrise scheme
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            if [[ "$BITRISE_APP_TITLE" == "staging-firefox-ios" ]]; then
                BUILD_TYPE="Debug"
            else
                BUILD_TYPE="Release"
            fi

            if [[ ! -z "${API_BITRISE_SCHEME}" ]]; then
              envman add --key BITRISE_SCHEME --value "${API_BITRISE_SCHEME}"
              envman add --key BITRISE_CONFIG --value "${API_BITRISE_SCHEME}${BUILD_TYPE}"
            else
              envman add --key BITRISE_SCHEME --value "Focus"
              envman add --key BITRISE_CONFIG --value "Focus${BUILD_TYPE}"
            fi
    - script@1.2.1:
        # If the current bitrise application is `staging-firefox-ios`, then
        # this is a test release made from the staging repository.
        # Ignore the value passed by release promotion for `BITRISE_SCHEME` and
        # force it to `FirefoxStaging`, which makes it use non production
        # certs/profiles. Also override the export method since the scheme is
        # using a developer ID, not a distribution one
        title: Set staging environment variables
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            envman add --key EXPORT_METHOD --value development
        run_if: |-
          {{enveq "BITRISE_APP_TITLE" "staging-firefox-ios"}}
    - certificate-and-profile-installer@1: {}
    - xcode-archive@5:
        inputs:
        - project_path: focus-ios/Blockzilla.xcodeproj
        - compile_bitcode: 'no'
        - upload_bitcode: 'no'
        - team_id: 43AQ936H96
        - export_method: "$EXPORT_METHOD"
        - output_tool: xcodebuild
        - distribution_method: "$EXPORT_METHOD"
        - export_development_team: 43AQ936H96
        - configuration: ${BITRISE_CONFIG}
        - platform: "iOS"
        - scheme: ${BITRISE_SCHEME}
        title: Build Focus
    - deploy-to-bitrise-io@2.9.2: {}
    envs:
    - opts:
        is_expand: false
      EXPORT_METHOD: app-store
    description: This step is used during release promotion to build a focus release

  release_promotion_push_focus:
    before_run:
    - SPM_Common_Steps
    envs:
    - IPA_PATH: /tmp/Client.ipa
    - DSYM_PATH: /tmp/symbols.zip
    steps:
    - script@1.2.1:
        title: Override default bitrise scheme
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            if [[ ! -z "${API_BITRISE_SCHEME}" ]]; then
              envman add --key BITRISE_SCHEME --value "${API_BITRISE_SCHEME}"
            else
              envman add --key BITRISE_SCHEME --value "Focus"
            fi

            if [[ "${API_BITRISE_SCHEME}" == "Focus" ]]; then
              envman add --key SENTRY_PROJECT --value "focus-ios"
            else
              envman add --key SENTRY_PROJECT --value "klar-ios"
            fi
    - file-downloader@1:
        title: Download Artifact
        inputs:
        - destination: $IPA_PATH
        - source: https://firefox-ci-tc.services.mozilla.com/api/queue/v1/task/$BUILD_TASK_ID/artifacts/public%2Frelease_promotion_promote_focus%2FFirefox%20${BITRISE_SCHEME}.ipa
    - file-downloader@1:
        title: Download symbols
        inputs:
        - destination: $DSYM_PATH
        - source: https://firefox-ci-tc.services.mozilla.com/api/queue/v1/task/$BUILD_TASK_ID/artifacts/public%2Frelease_promotion_promote_focus%2FFirefox%20${BITRISE_SCHEME}.dSYM.zip
    - script@1.2.1:
        title: Check if IPA was downloaded
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -xe
            echo "$IPA_PATH"
            file "$IPA_PATH"
            shasum -a 256 "$IPA_PATH"
            unzip -p "$IPA_PATH" "Payload/*.app/Info.plist" | plutil -p - | grep CFBundleIdentifier
            unzip -p "$IPA_PATH" "Payload/*.app/Info.plist" | plutil -p - | grep CFBundleVersion
            unzip -p "$IPA_PATH" "Payload/*.app/Info.plist" | plutil -p - | grep CFBundleShortVersionString
    - script@1.2.1:
        title: Check if symbols were downloaded
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -xe
            echo "$DSYM_PATH"
            file "$DSYM_PATH"
    - script@1.2.1:
        title: Upload Firefox Focus Symbols
        run_if: |-
          {{enveq "BITRISE_APP_TITLE" "firefox-ios"}}
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -xe
            firefox-ios/ThirdParty/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN" upload-dif \
              --org mozilla --project ${SENTRY_PROJECT} "$DSYM_PATH"
    - deploy-to-itunesconnect-application-loader@1:
        title: Deploy to AppStoreConnect
        run_if: |-
          {{enveq "BITRISE_APP_TITLE" "firefox-ios"}}
        inputs:
        - connection: 'off'
        - app_password: "$APPLE_ACCOUNT_PW"
        - itunescon_user: "$APPLE_ACCOUNT_ID"
        - ipa_path: $IPA_PATH
        - retries: 5

  release_promotion_promote:
    before_run:
    - SPM_Common_Steps
    steps:
    - script@1.2.1:
        title: Override default bitrise scheme
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            if [[ ! -z "${API_BITRISE_SCHEME}" ]]; then
              envman add --key BITRISE_SCHEME --value "${API_BITRISE_SCHEME}"
            fi
    - script@1.2.1:
        # If the current bitrise application is `staging-firefox-ios`, then
        # this is a test release made from the staging repository.
        # Ignore the value passed by release promotion for `BITRISE_SCHEME` and
        # force it to `FirefoxStaging`, which makes it use non production
        # certs/profiles. Also override the export method since the scheme is
        # using a developer ID, not a distribution one
        title: Set staging environment variables
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex
            envman add --key BITRISE_SCHEME --value FirefoxStaging
            envman add --key EXPORT_METHOD --value development
        run_if: |-
          {{enveq "BITRISE_APP_TITLE" "staging-firefox-ios"}}
    - script@1.2.1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -xe

            cd firefox-ios/Client.xcodeproj
            sed -i '' 's/CODE_SIGN_IDENTITY = "iPhone Developer"/CODE_SIGN_IDENTITY = "iPhone Distribution"/' project.pbxproj
            cd -
        title: Set xcodeproj code_sign_identity
        run_if: |-
          {{enveq "BITRISE_APP_TITLE" "firefox-ios"}}
    - script@1.2.1:
        title: NPM, ContentBlockerGen
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -xe

            ./bootstrap.sh
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: firefox-ios/Client/Info.plist
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: firefox-ios/Extensions/NotificationService/Info.plist
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: firefox-ios/Extensions/ShareTo/Info.plist
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: firefox-ios/WidgetKit/Info.plist
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: firefox-ios/CredentialProvider/Info.plist
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: firefox-ios/sticker/Info.plist
    - set-xcode-build-number@1:
        inputs:
        - build_short_version_string: "$BITRISE_RELEASE_VERSION"
        - plist_path: firefox-ios/Extensions/ActionExtension/Info.plist
    - script@1.2.1:
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -xe

            echo "Setting Nimbus variables"
            /usr/libexec/PlistBuddy -c "Set NimbusURL $NIMBUS_URL" "firefox-ios/Client/Info.plist"
        title: Nimbus Variable Setup
    - xcode-archive@5:
        inputs:
        - project_path: firefox-ios/Client.xcodeproj
        - compile_bitcode: 'no'
        - upload_bitcode: 'no'
        - team_id: 43AQ936H96
        - export_method: "$EXPORT_METHOD"
        - output_tool: xcodebuild
        - distribution_method: "$EXPORT_METHOD"
        - export_development_team: 43AQ936H96
        - configuration: "$BITRISE_SCHEME"
    - deploy-to-bitrise-io@2.9.2: {}
    envs:
    - opts:
        is_expand: false
      EXPORT_METHOD: app-store
    description: This step is used during release promotion to build a firefox release

  AddNightlyGroupToTestFlightBeta:
    description: This step is used to add the Nightly group to the Beta build in TestFlight.
    before_run:
    - SPM_Common_Steps
    steps:
    - script@1.2.1:
        title: Add Nightly Group to Beta Build
        inputs:
        - content: |-
            #!/usr/bin/env bash
            python3 -m pip install --upgrade pip pyjwt cryptography requests
            python3 scripts/nightly_testflight_add_group.py

  release_promotion_push:
    before_run:
    - SPM_Common_Steps
    envs:
    - IPA_PATH: /tmp/Client.ipa
    - DSYM_PATH: /tmp/symbols.zip
    steps:
    - file-downloader@1:
        title: Download Artifact
        inputs:
        - destination: $IPA_PATH
        - source: https://firefox-ci-tc.services.mozilla.com/api/queue/v1/task/$BUILD_TASK_ID/artifacts/public%2Frelease_promotion_promote%2FClient.ipa
    - file-downloader@1:
        title: Download symbols
        inputs:
        - destination: $DSYM_PATH
        - source: https://firefox-ci-tc.services.mozilla.com/api/queue/v1/task/$BUILD_TASK_ID/artifacts/public%2Frelease_promotion_promote%2FClient.dSYM.zip
    - script@1.2.1:
        title: Check if IPA was downloaded
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -xe
            echo "$IPA_PATH"
            file "$IPA_PATH"
            shasum -a 256 "$IPA_PATH"
            unzip -p "$IPA_PATH" "Payload/*.app/Info.plist" | plutil -p - | grep CFBundleIdentifier
            unzip -p "$IPA_PATH" "Payload/*.app/Info.plist" | plutil -p - | grep CFBundleVersion
            unzip -p "$IPA_PATH" "Payload/*.app/Info.plist" | plutil -p - | grep CFBundleShortVersionString
    - script@1.2.1:
        title: Check if symbols were downloaded
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -xe
            echo "$DSYM_PATH"
            file "$DSYM_PATH"
    - script@1.2.1:
        title: Upload Firefox Prod Beta Symbols
        run_if: |-
          {{enveq "BITRISE_APP_TITLE" "firefox-ios"}}
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -xe
            firefox-ios/ThirdParty/sentry-cli --auth-token "$SENTRY_AUTH_TOKEN_FIREFOX" upload-dif \
              --org mozilla --project firefox-ios "$DSYM_PATH"
    - deploy-to-itunesconnect-application-loader@1:
        title: Deploy to AppStoreConnect
        run_if: |-
          {{enveq "BITRISE_APP_TITLE" "firefox-ios"}}
        inputs:
        - connection: 'off'
        - app_password: "$APPLE_ACCOUNT_PW"
        - itunescon_user: "$APPLE_ACCOUNT_ID"
        - ipa_path: $IPA_PATH
        - retries: 5

app:
  envs:
  - opts:
      is_expand: false
    BITRISE_EXPORT_METHOD: development
  - opts:
      is_expand: false
    BITRISE_NIGHTLY_VERSION: '9000'
  - opts:
      is_expand: false
    BITRISE_PROJECT_PATH: './firefox-ios/Client.xcodeproj'
  - opts:
      is_expand: false
    BITRISE_SCHEME: 'Fennec'
  - opts:
      is_expand: false
    BITRISE_DESTINATION: 'platform=iOS Simulator,name=Bitrise iOS default,OS=latest'
  - opts:
      is_expand: false
    TEST_FLIGHT_EXTERNAL_GROUP_NAME: Nightly
  - opts:
      is_expand: false
    APPLE_TEAM_ID: '43AQ936H96'

trigger_map:
- push_branch: main
  pipeline: pipeline_build_and_test
- push_branch: epic-branch/*
  pipeline: pipeline_build_and_test
- push_branch: release/*
  pipeline: pipeline_build_and_test
- pull_request_target_branch: main
  pipeline: pipeline_build_and_test
- pull_request_target_branch: epic-branch/*
  pipeline: pipeline_build_and_test
- pull_request_target_branch: release/v*
  pipeline: pipeline_build_and_test

meta:
  bitrise.io:
    stack: osx-xcode-26.1.x
    machine_type_id: g2.mac.4large
